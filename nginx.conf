server {
    listen 6080;
    server_name _;

    # Add permissions policy for fullscreen
    add_header Permissions-Policy "fullscreen=(self)";
    add_header Feature-Policy "fullscreen *";
    
    # WebSocket support
    location /websockify {
        proxy_pass http://localhost:6081;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_read_timeout 86400;
    }
    
    # noVNC static files
    location / {
        root /opt/novnc;
        index vnc.html index.html;
        try_files $uri $uri/ =404;
        
        # Allow fullscreen
        add_header Permissions-Policy "fullscreen=(self)";
        add_header Feature-Policy "fullscreen *";
    }

    location = /logout {
        default_type text/html;
        add_header Cache-Control "no-store";
        add_header WWW-Authenticate "Basic realm=\"Triplo noVNC\"";
        return 401 '<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Logged out</title><meta http-equiv="refresh" content="0;url=/"></head><body style="font-family: -apple-system, BlinkMacSystemFont, Segoe UI, sans-serif; margin: 2rem;"><p>You have been signed out of the remote desktop. Redirecting...</p><script>setTimeout(function(){ window.location.replace("/"); }, 50);</script></body></html>';
    }
}
